<!DOCTYPE html>
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Mapping NPR Tiny Desk</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://js.arcgis.com/3.27/esri/css/esri.css">
        <link rel="stylesheet" href="https://js.arcgis.com/3.27/dijit/themes/claro/claro.css">
        <script src="https://js.arcgis.com/3.27"></script>  
        <style>

#title{
    color:white;
}
#artistChoices{
    height: 25px;
    padding-top: 10px;
}
div {
    position:relative;
    font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
}

.tabOptions{
    font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
}

/* ARTIST TOC ITEMS */
/* img {
    position:absolute;
    top:0;
    bottom:0;
    margin:auto;
} */
.image {
    min-height:50px;
    display: block;
}

#artist-popup{
    position: fixed;
    bottom: 0;
    z-index:2147483638;
}

#artist-selection{
    padding-left: 10px;
}
#artist-Choices{
    padding-left: 10px;
}


img {
    vertical-align: middle;
    max-height: 120px;
    max-width: 120px;
}
#logo{
    float: left;
}

#title-wrapper{
    position: relative;
    vertical-align: middle;
    border-bottom: thick double #EE3A23;
}

#logo-description{
    vertical-align: middle;
    font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    padding-left: 115px;
}
       
html, body, .container, #map {
    height:100%;
    width:100%;
    margin:0;
    padding:0;
    margin:0;
    font-family: "Open Sans";
            }
#map {
    padding:0;
}
#table-of-contents{
    width:32%;
}

.esriLayer{
background-color: #fff;
}
.esriLayerList .esriList{
    border-top:none;
}
.esriLayerList .esriTitle {
background-color: #fff;
border-bottom:none;
}
.esriLayerList .esriList ul{
background-color: #fff;
}
.pane-container{
    width:100%;
    height:50%;
}
.pane-header{
    height:6%;
    width:100%;
    background-color: rgb(105, 22, 105);    
    border-bottom: 1px solid #444;        
}
.pane-header-text{
    padding-left: 5px;
    color: white;
    font-weight: bold;
}

div.artist-toc {
    margin: 5px;
    border: 1px solid #ccc;
    float: left;
  }
  
  div.artist-toc:hover {
    border: 1px solid #777;
  }
  
  div.artist-toc img {
    /* width: 100%; */
    height: 100%;
    height: inherit;
  }
  
/* 

.relative{position:relative; width:600px;}
.absolute-text{position:absolute; bottom:0; font-size:24px; font-family:"vedana"; background:rgba(251,251,251,0.5);
padding:10px 20px; width:100%; text-align:center;}
.absolute-text a{font-size:16px; color:#b92b27;}

 */

 /* https://www.w3schools.com/howto/howto_css_modals.asp */

 .modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
}

/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}
















</style>
    </head>



    
    <script>
       
        require([   
                "dojo/parser",
                "dojo/ready",
                "dojo/on",
                "dojo/dom-construct", 
                "dojo/dom",
                "dijit/registry", 
                "esri/map",
                "esri/layers/ArcGISDynamicMapServiceLayer",
                "esri/layers/FeatureLayer",
                "esri/urlUtils",
                "esri/arcgis/utils",
                "esri/dijit/LayerList",
                "esri/InfoTemplate",
                "esri/renderers/smartMapping",
                "esri/tasks/FindTask",
                "esri/tasks/FindParameters",
                'dojo/query',
                "esri/tasks/query",
                'esri/tasks/QueryTask',
                "esri/dijit/OverviewMap",
                "esri/dijit/Legend",
                "dijit/form/Select",
                "dojo/store/Memory",
                 "dijit/form/FilteringSelect",
                "dijit/_WidgetBase", //start undeclared
                "dijit/layout/BorderContainer",
                "dijit/layout/ContentPane",
                "dijit/layout/TabContainer",
                "dojo/domReady!"
            ],
            function(
                parser,
                ready,
                on,
                domConstruct,
                dom,
                registry,
                Map,
                DynamicMapService,
                FeatureLayer,
                urlUtils,
                arcgisUtils,
                LayerList,
                InfoTemplate,
                smartMapping,
                FindTask,
                FindParameters,
                query, 
                esriQuery,
                QueryTask, 
                OverviewMap,
                Legend,
                Select,
                Memory,
                FilteringSelect
            ) {
                 
                var map,
                    OverviewMap,
                    mapLayers,
                    nprArtistLayerId, 
                    artistOptions,
                    artistLookupObject,
                    artistOptionsWidget;

                parser.parse();


                const agsURL = 'http://54.147.1.38:6080/arcgis/rest/services';
                const nprSitesService = agsURL + '/nprTinyDesk/FeatureServer/0';
                const nprMapService = 'http://54.147.1.38:6080/arcgis/rest/services/nprTinyDesk/MapServer'
                artistLookupObject = {};
                
                var modal = document.getElementById('myModal');
                var btn = document.getElementById("myBtn");
                var span = document.getElementsByClassName("close")[0];
               
				function init(){     
                    
                    modal.style.display = "block"
					map = new Map("map", {
						basemap:"topo-vector",
						center: [-100.0850508, 41.647463],
						zoom: 3
                	});   

                    // var nprArtists = "npr-artists";
                    // nprArtistsLayer  = new DynamicMapService(nprSitesService, {
                    //     "id": nprArtists, 
                    //     "opacity": .9,
                    // });

					var nprArtists = 'npr-artists'
                    nprArtistsLayer = new FeatureLayer(nprSitesService , {
                        "opacity": 0.9,
                        id: nprArtists,
                        mode: FeatureLayer.MODE_SNAPSHOT,
                        outFields: ["*"],
                        // infoTemplate: new InfoTemplate("")
                    });

                    function createOverviewmap(map){
                        overviewMap = new OverviewMap({
                        map: map,
                        visible: true
                        });
                        overviewMap.startup();
				    }

                    function fetchArtistInfo(nprSitesService){
                        //Responsible for querying feature service and returning guid, name, screenshot img
                        // could have used this, https://developers.arcgis.com/javascript/latest/api-reference/esri-tasks-support-Query.html#returnDistinctValues
                        var queryTask = new QueryTask(nprSitesService);
                        var query = new esriQuery();
                        query.returnGeometry = false;
                        query.outFields = ["title","description", "pubDate", "guid_", "imgLink", "actURL", "NEAR_DIST"];
                        query.where = "1=1"
                        queryTask.execute(query,createArtistTOC); 
                        console.log("Executed");
                    }
                    
                    function createArtistTOC(artistInfoResponse){
                        //Responsible for parsing response from feature service endpoint and rendering TOC items
                        
                        function __getValues__(response) {
                            var features = response.features;
                            var values = features.map(function (feature) {
                                return feature.attributes.SUB_REGION;
                            });
                            return values;
                        }

                        let artistRecords = artistInfoResponse.features;
                        let artistOptionsArray = []
                        for (i = 0; i < artistRecords.length; i++) { 
                            let actName = artistRecords[i].attributes.title;
                            let actGUID = artistRecords[i].attributes.guid_;
                            artistLookupObject[actName] = artistRecords[i].attributes;
                            let item = {label:actName, value: actGUID};
                            artistOptionsArray.push(item)
                        }
                        artistLookupReference = artistLookupObject;

                        // artistOptionsArray = __getValues__(artistInfoResponse) // old array getter

                        artistOptionsArray.sort(function(a, b) {
                            var textA = a.label.toUpperCase();
                            var textB = b.label.toUpperCase();
                            return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
                        });

                        let artistOptionsStore = new Memory({
                            data: artistOptionsArray
                        });

                        artistOptions = new FilteringSelect({
                            name: "artist-Selection",
                            id: "artistSelection",
                            value: "Dan Auerbach",
                            store: artistOptionsStore,
                            searchAttr: "label"
                        });
                        artistOptions.placeAt("artist-Choices");
                        
                        artistOptions.on('change', function(evt){
                            console.log(evt);
                        });
                        artistOptions.startup(); 


                        for (var key in artistLookupReference) {
                            let artist = key; 
                            let attributes = artistLookupReference[artist];
                            let title = attributes.title;
                            let description = attributes.description;
                            let pubDate = attributes.pubDate;
                            let guid = attributes._guid;
                            let imgLink = attributes.imgLink;
                            let dlLink = attributes.actURL;
                            if (attributes.NEAR_DIST == 0){ //if vertex is in same place, set property to flag as true. 
                                attributes.sharedLoc = true;
                            }
                            else{
                                attributes.sharedLoc = true;
                            }
                            
                            createTOCItem(title, description, guid, imgLink,dlLink )
                        }


                    }
                   
                    function createTOCItem(title, description, guid, imgLink, download_link){
                        
                        function __updateQueryStringParameter__(uri, key, value) {
                            // https://stackoverflow.com/questions/5999118/how-can-i-add-or-update-a-query-string-parameter
                            var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
                            var separator = uri.indexOf('?') !== -1 ? "&" : "?";
                            if (uri.match(re)) {
                                return uri.replace(re, '$1' + key + "=" + value + '$2');
                            }
                            else {
                                return uri + separator + key + "=" + value;
                            }
                        }

                        //Responsible for creating the actual dom elements in the TOC/Grid
                        var parentDiv = document.createElement("div");
                            parentDiv.classList.add("artist-toc"); //used to be gallery
                            
                            var childLink = document.createElement("div"); //"a"
   
                           
                            imgLink = __updateQueryStringParameter__(imgLink, 's', 100);
                            childThumbnail = document.createElement('img')
                                childThumbnail.setAttribute('src', imgLink);
                                childThumbnail.setAttribute('alt', description);
                                childThumbnail.setAttribute('title', description);
                                childThumbnail.setAttribute('name', title);
                                childThumbnail.setAttribute('width', 100);
                                childThumbnail.setAttribute('height', 100);
                            
                            childThumbnail.onmouseover= function(){
                                let artistName = this.name;

                            }

                            childLink.appendChild(childThumbnail);
                            parentDiv.appendChild(childLink);
                            var childDiv = document.createElement("div"); 
                                childDiv.classList.add("desc");
                                childDiv.innerHTML = name;

                            parentDiv.appendChild(childDiv);
                            document.getElementById("artist-toc-items").appendChild(parentDiv); 
                    }
     
                    createOverviewmap(map);

                    map.addLayer(nprArtistsLayer);
                    fetchArtistInfo(nprSitesService);

                    // When the user clicks on <span> (x), close the modal
                    span.onclick = function() {
                        modal.style.display = "none";
                    }

                    // When the user clicks anywhere outside of the modal, close it
                    window.onclick = function(event) {
                        if (event.target == modal) {
                            modal.style.display = "none";
                        }
                    }
                
                }

                init();

                
           
            });

    </script>

    <body class="claro">
        <div id="myModal" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
                <span class="close">&times;</span>
                <img id='intro-image' src='https://media.npr.org/assets/img/2018/08/06/npr_tdconcerts_podcasttile_video_sq-b6365c34821ed5be5eb8668a7ca1583e3d7ceb51.jpg?f=thumbnail%22'>
                <p>This Map-Centric Web Application is designed to visualize the NPR Tiny Desk Series. You can......</p>
                <ol>
                    <li>View Artists Hometown/Origin</li>
                    <li>Link to Artists Tiny Desk Sessions</li>
                    <li>Search for Artists by location</li>
                </ol>
            </div>        
        </div>
        <div class="container" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline',gutters:false">
            <div id="title-wrapper" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'">
                <img class='image' id="logo" src='https://media.npr.org/assets/img/2013/06/19/color-logo-in-square-01_wide-9761a9419cd1b3478cbe493a7b83f9908f989d8e.jpg'>  
                <div class='title-item' id="logo-description"> <h1>NPR Tiny Desk Acts</h1></div>
            </div>
            <div id="table-of-contents" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'left'">
                <div id="navBar" data-dojo-type="dijit/layout/TabContainer" data-dojo-props="region: 'left'" style="width:20%">            
                    <div class="tabOptions" id="mapChoices" data-dojo-type="dijit/layout/ContentPane" title="Tiny Desk Artists">

                        <div id="artist-Choices" data-dojo-type="dijit/layout/ContentPane" title="Map Options">Please select an Artist</div>
                        <div id="artist-selection" data-dojo-type="dijit/layout/ContentPane" title="Map Options">
                            <span>Current Selected Artist </span>
                        </div>
                        
                        <div id="artist-toc-items" data-dojo-type="dijit/layout/ContentPane"></div>   
                    </div>
                    <div class="tabOptions"  id="mapLegend" data-dojo-type="dijit/layout/ContentPane" title="Search By">
                        <div id="legend"></div>
                    </div>			
              </div>        
            </div>
            <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'">
               
            </div>
           
        </div>
    </body>

</html>
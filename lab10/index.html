<!DOCTYPE html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>Lab 9 - Thomas Moran</title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://js.arcgis.com/3.28/esri/css/esri.css">
		<link rel="stylesheet" href="https://js.arcgis.com/3.28/dijit/themes/claro/claro.css">
		<script src="https://js.arcgis.com/3.28/"></script>
		<style>
			
			html, body, .container, #map {
					height:100%;
					width:100%;
					margin:0;
					padding:0;
					margin:0;
					font-family: "Open Sans";
							}
			#map {
				padding:0;
			}
			#table-of-contents{
				width:25%;
			}

			#title-block{
				color: white;
				background-color: rgb(8, 8, 99)
			}

			#search-title{
				color: white;
				background-color: rgb(83, 30, 83);
				display: block;
				font-weight: bold;
			}


			#buffer-btn{

				display: flex;
				align-items: center;
				justify-content: center;

			}


			#search-condition-btn-container{
				padding-top: 5px;
			}

			#search-results-container{
				border-style: solid;
				border-width: 1px;
				border-color: rgb(82, 81, 81);
				height: 600px;
			}

			#geocoding-description{
				padding-top: 5px;
			}

			#where-clause-container{
				padding: 2px;
				display: block;
			}
			.search-option{
				display: inline-block;
			}

			#horizontal-slider{
				padding-top: 10px;
			}



		
		</style>
	</head>
	
	<script>

	  
		require([   
				"dojo/parser",
				"dojo/ready",
				"dojo/on",
				"dojo/dom-construct", 
				'dojo/dom-style',
				'dojo/query',
				"esri/tasks/query",
				'esri/tasks/QueryTask',
				"esri/symbols/SimpleMarkerSymbol",
				"esri/graphicsUtils",
				"esri/graphic", 
				"esri/geometry/Extent",
				"esri/tasks/locator", 
				"esri/geometry/Point",
				"dgrid/Grid",
				"dgrid/Selection",
				'dojo/_base/declare',
				"dojo/dom",
				"dijit/registry", 
				"dojo/_base/array",
				"esri/map",
				"esri/SpatialReference",
				"esri/layers/ArcGISDynamicMapServiceLayer",
				"esri/layers/FeatureLayer",
				"esri/urlUtils",
				"esri/arcgis/utils",
				"esri/dijit/LayerList",
				"esri/InfoTemplate",
				"dojo/_base/Color",
				"esri/renderers/smartMapping",
				"esri/dijit/Legend",
				"dijit/form/Select",
				"dijit/form/RadioButton",
				"dijit/form/HorizontalSlider",
				"dijit/form/HorizontalRule",
				"dijit/form/HorizontalRuleLabels",
				"dojo/aspect",
				"dijit/form/Button",
				"dijit/_WidgetBase", //start undeclared
				"dijit/layout/BorderContainer",
				"dijit/layout/ContentPane",
				"dijit/layout/TabContainer",
				"dojo/domReady!"
			],
			function(
				parser,
				ready,
				on,
				domConstruct,
				domStyle,
				query, 
				esriQuery,
				QueryTask, 
				SimpleMarkerSymbol,
				graphicsUtils,
				Graphic,
				Extent, 
				Locator,
				Point,
				Grid,
				Selection,
				declare,
				dom,
				registry,
				array,
				Map,
				SpatialReference,
				DynamicMapService,
				FeatureLayer,
				urlUtils,
				arcgisUtils,
				LayerList,
				InfoTemplate,
				Color,
				smartMapping,
				Legend,
				Select,
				RadioButton,
				HorizontalSlider,
				HorizontalRule,
				HorizontalRuleLabels,
				aspect
			) {
				parser.parse();      

				const agsURL = 'http://35.175.150.188:6080/arcgis/rest/services'
				const blockGroupService = agsURL + '/Travis_Pop2010/MapServer';

				const geocodingServer = 'http://35.175.150.188:6080/arcgis/rest/services/Austin_Streets/GeocodeServer';
				const locator = new Locator(geocodingServer);
	
				var horizontalSlider = registry.byId("horizontal-slider"), 
					bufferLabel = dom.byId("bufferValue"),
					bufferSearchBtn = dom.byId("buffer-btn"),
					geocodingContents = dom.byId("geocoding-contents"),
					bufferLayer;


				function init(){     
			   
					map = new Map("map", {
						basemap:"topo",
						center: [-97.83298, 30.2225],
						zoom: 10
					});    


					var blocksID = "travis-county-blocks";
					travisCountyBlocksLyr  = new DynamicMapService(blockGroupService, {
						"id": blocksID, 
						"opacity": .6,
					});
					map.addLayer(travisCountyBlocksLyr);

					bufferLayer = new esri.layers.GraphicsLayer();

				}
				
				function updateHorizontalLabel() {
					bufferLabel.innerHTML = horizontalSlider.get("value");
				}

				function executeBuffer(){

					let graphicsLength = map.graphics.graphics.length; 
					let inputGraphics = map.graphics.graphics;
					

					let gpTask = ""; 
					let gpResults;



					if (graphicsLength >= 1){
						console.log("Executing Buffer.");

						var symbol = new esri.symbol.SimpleFillSymbol(
							esri.symbol.SimpleFillSymbol.STYLE_SOLID,
							new esri.symbol.SimpleLineSymbol(
							  esri.symbol.SimpleLineSymbol.STYLE_SOLID,
							  new dojo.Color([0,0,255,0.65]), 2
							),
							new dojo.Color([0,0,255,0.35])
						);

						dojo.forEach(bufferedResults, function(geometry) {
							let graphic = new esri.Graphic(geometry,symbol);
							let bufferInfoTemplate = new InfoTemplate( 
								"Population in the buffer zone", 
								"Total Population: ${population}"
							);
							graphic.setInfoTemplate(bufferInfoTemplate);
							map.graphics.add(graphic);
						});


						console.log(bufferLayer);





					}
					else{
						alert("You don't have geocoded addresses for buffering");
					}


					
				}

				function addResults(candidateLength, results){
					
					map.graphics.clear();
			

					let geocodeScoreMinimum = 80; //values equal or under will be removed
					let extents = [];
					let validCandidates = 0; 
					for( var i = 0; i < results.length; i++){//removes score under the geocode score threshold
						let currentAddressResult = results[i];
						let currentScore = currentAddressResult.score;
				
						if (currentScore > geocodeScoreMinimum) {
							validCandidates += 1;
							// 1. set point
							// 2. set simple marker symbol
							// 3. set attributes
							// 4. set infotemplate
							let x = currentAddressResult.location.x;
							let y = currentAddressResult.location.y;
							extents.push(currentAddressResult.location);

							let pt = new Point(x,y, map.spatialReference); // #1

							let sms = new SimpleMarkerSymbol().setStyle( // #2
								SimpleMarkerSymbol.STYLE_SQUARE).setColor(
									new Color([255,0,0,0.5])
								)
							let attr = {"Address": currentAddressResult.address,"Score": currentScore}; // #3

							var infoTemplate = new InfoTemplate( 
								"Location", 
								"Address: ${Address}<br />Score: ${Score}"
							);

							let graphic = new Graphic(pt,sms,attr,infoTemplate);

							map.graphics.add(graphic);

						}
						else{
							continue; //continue if score is not met
						}

					}
					
					let geocodedAddressesExtent = graphicsUtils.graphicsExtent(map.graphics.graphics)
					map.setExtent(geocodedAddressesExtent, true);
					alert(`${validCandidates} out of ${candidateLength} addresses were successfully geocoded!`);

				}

				function geocodeFailure(err){
					alert('Geocoding did not execute properly! Please rerun!');
				}

				function executeGeocode	(){
					let addressContent = geocodingContents.value;
					let addressContentLength = addressContent.length;
					let addressCandidates = [];

					if (addressContentLength >= 1){
						// console.log(addressContent);
						let addresses = addressContent.replace(/\r\n/g, "\n").split("\n");
						let addressCount = addresses.length;

						for (var i = 1; i < addressCount; i++) {
							let currentAddress = addresses[i];
							
							//wanted to use new operator here but property with spaces doesnt work as class property
							let currentAddressCandidate = {
							  "OBJECTID": i,
							  "Single Line Input": currentAddress
							}

							addressCandidates.push(currentAddressCandidate)
						}

						var options = {
							addresses: addressCandidates
						}

						locator.outSpatialReference = map.spatialReference;
						locator.addressesToLocations(options, addResults.bind(this, addressCount), geocodeFailure)
					}
					else{
						alert('Please enter at least one address!')
					}
					console.log("Executing Geocode.");

				}

				aspect.after(horizontalSlider, "onChange", updateHorizontalLabel, true);
				updateHorizontalLabel();

				on(query('#buffer-btn'), 'click', function(){
					executeBuffer();
				});

				on(query('#geocode-btn'), 'click', function(){
					executeGeocode();
				});

				init();

			});
	
	</script>
	
	<body class="claro">
		<div class="container" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline',gutters:false">
			<div id="title-block" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'">
				<div id="title"><h2>2010 Population Map of Travis County, Texas</h2></div>
			</div>
			<div id="table-of-contents" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'left'">
				<div id="geocoding-container" style="height: 70%;" class="pane-container" data-dojo-type="dijit/layout/ContentPane">             
					<div id="search-title">Geocoding Addresses</div>   
					<div id="geocoding-description">
						Please copy your addresses into the text area below <br>
						Each address should start in a new line. 
					</div>
					<textarea id="geocoding-contents" rows="25" cols="60"></textarea>
					<button id="geocode-btn" data-dojo-type="dijit/form/Button" type="button">
						Geocode
					</button>


				</div>
				<div id="buffer-container" style="height: 30%;" class="pane-container" data-dojo-type="dijit/layout/ContentPane">
					<div id="search-title">Buffering Locations</div>   
					<div id="slider-container" style="padding-top: 10px;">
						<input id="horizontal-slider" type="range" value="0"
								data-dojo-type="dijit/form/HorizontalSlider"
								data-dojo-props="
									minimum: 0,
									maximum: 5,
									showButtons: false,
									discreteValues: 6">
						<div data-dojo-type="dijit/form/HorizontalRule"
						data-dojo-props="
							container: 'bottomDecoration',
							count: 6"
							style="height: 5px;">    
						</div>
						<ol data-dojo-type="dijit/form/HorizontalRuleLabels"
							data-dojo-props="
								container: 'bottomDecoration'"
							style="height: 1em;">
							<li>0</li>
							<li>1</li>
							<li>2</li>
							<li>3</li>
							<li>4</li>
							<li>5</li>
						</ol>

						<div style="padding-top: 10px; text-align: center;">Value: <strong id="bufferValue"></strong></div>
					</div>
					<button id="buffer-btn" data-dojo-type="dijit/form/Button" type="button">
						Buffer
					</button>
				</div>          
			</div>
			<div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'"></div>
		</div>
	</body>

</html>

<!-- 
	// for( var i = 0; i < results.length; i++){ 
					//    let currentAddressResult = results[i];
					//    let currentScore = currentAddressResult.score;
					//    if ( currentScore <= geocodeScoreMinimum) {
					//      results.splice(i, 1); 
					//      i--;
					//    }
					// } 




	//travisCountyBlocksLyr.setVisibleLayers([0]);      -- multilayer methods  
					//map.addLayers([travisCountyBlocksLyr]);



					// var horizontalSlider = new HorizontalSlider({labels: ["0", "1", "2", "3", "4", "5"]}, "horizontal-slider"); -- programatic standup not declarative
					// var horizontalSlider = new HorizontalSlider({discreteValues: 6, showButtons: false}, "horizontal-slider").startup();
				  





					-->